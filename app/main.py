from __future__ import annotations

import asyncio
import httpx
import json
import logging
import uuid
from pathlib import Path

from fastapi import FastAPI, Form, Request
from fastapi.responses import FileResponse, HTMLResponse, JSONResponse, Response, RedirectResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

from app.config import settings
from app.services.archiver import Archiver
from app.storage.supabase import get_supabase, save_archive
from app.utils import is_valid_url

logger = logging.getLogger(__name__)
app = FastAPI(title=settings.app_name)
app.mount("/static", StaticFiles(directory="app/static"), name="static")
templates = Jinja2Templates(directory="app/templates")

# ÙˆØ¶Ø¹ÛŒØª Ø¬Ø§Ø¨Ù‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´: job_id -> {status, archive_id, error, url}
_jobs: dict[str, dict] = {}


@app.on_event("startup")
async def startup():
    if settings.telegram_bot_token and settings.webhook_url:
        endpoint = f"{settings.webhook_url.rstrip('/')}/bot/webhook"
        try:
            async with httpx.AsyncClient(timeout=10) as c:
                r = await c.post(
                    f"https://api.telegram.org/bot{settings.telegram_bot_token}/setWebhook",
                    json={"url": endpoint},
                )
                logger.info("Webhook set: %s â†’ %s", endpoint, r.json().get("ok"))
        except Exception as e:
            logger.warning("Webhook setup failed: %s", e)


@app.get("/", response_class=HTMLResponse)
async def index(request: Request):
    return templates.TemplateResponse("index.html", {"request": request, "result": None, "error": None})


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ØªØ§Ø¨Ø¹ background Ø¢Ø±Ø´ÛŒÙˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def _run_archive(job_id: str, url: str, send_telegram: bool):
    _jobs[job_id] = {"status": "running", "url": url, "archive_id": None, "error": None}
    try:
        artifact = await Archiver().archive(url)
        archive_id = await save_archive(artifact)
        artifact.archive_id = archive_id
        artifact.public_url = f"{settings.archive_base}/view/{archive_id}"

        # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
        if send_telegram and settings.telegram_bot_token and settings.telegram_chat_id:
            try:
                TGAPI = f"https://api.telegram.org/bot{settings.telegram_bot_token}"
                target = settings.telegram_chat_id
                async with httpx.AsyncClient(timeout=60) as tc:
                    cap = f"ğŸ“¦ archive.html\nğŸ”— {url}\nğŸŒ {artifact.public_url}"
                    with artifact.rendered_html_path.open("rb") as f:
                        await tc.post(f"{TGAPI}/sendDocument",
                                      data={"chat_id": target, "caption": cap},
                                      files={"document": ("archive.html", f)})
                    if artifact.screenshot_path.exists() and artifact.screenshot_path.stat().st_size > 2000:
                        with artifact.screenshot_path.open("rb") as f:
                            await tc.post(f"{TGAPI}/sendPhoto",
                                          data={"chat_id": target, "caption": f"ğŸ“¸ {url}"},
                                          files={"photo": ("screenshot.png", f)})
            except Exception as e:
                logger.warning("Telegram send failed: %s", e)

        _jobs[job_id] = {"status": "done", "url": url, "archive_id": archive_id, "error": None}
        logger.info("Job %s done: %s", job_id, archive_id)

    except Exception as e:
        logger.exception("Job %s failed: %s", job_id, url)
        _jobs[job_id] = {"status": "error", "url": url, "archive_id": None, "error": str(e)[:300]}


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# POST /archive â€” ÙÙˆØ±ÛŒ redirect Ø¨Ù‡ ØµÙØ­Ù‡ Ø§Ù†ØªØ¸Ø§Ø±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/archive")
async def do_archive(
    request: Request,
    url: str = Form(...),
    save_local: bool = Form(False),
    save_telegram: bool = Form(False),
):
    if not is_valid_url(url):
        return templates.TemplateResponse(
            "index.html",
            {"request": request, "error": "URL Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.", "result": None},
            status_code=400,
        )

    job_id = str(uuid.uuid4())[:8]
    # Ø¢Ø±Ø´ÛŒÙˆ Ø¯Ø± background â€” Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ redirect Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    asyncio.create_task(_run_archive(job_id, url, save_telegram))

    return RedirectResponse(f"/status/{job_id}", status_code=303)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GET /status/{job_id} â€” ØµÙØ­Ù‡ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§ polling
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/status/{job_id}", response_class=HTMLResponse)
async def job_status_page(job_id: str):
    job = _jobs.get(job_id, {})
    url = job.get("url", "")
    base = settings.archive_base or ""

    page = f"""<!DOCTYPE html>
<html lang='fa' dir='rtl'>
<head>
<meta charset='UTF-8'/>
<meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>Ø¢Ø±Ø´ÛŒÙˆ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´</title>
<link href='https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap' rel='stylesheet'/>
<style>
*{{box-sizing:border-box;margin:0;padding:0;}}
body{{font-family:'Vazirmatn',sans-serif;background:#060910;color:#e2e8f0;min-height:100vh;
  display:flex;align-items:center;justify-content:center;}}
.card{{background:rgba(255,255,255,.05);border:1px solid rgba(99,102,241,.25);
  border-radius:24px;padding:48px;max-width:540px;width:90%;text-align:center;}}
.spinner{{width:56px;height:56px;border:4px solid rgba(99,102,241,.2);
  border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 24px;}}
@keyframes spin{{to{{transform:rotate(360deg);}}}}
h2{{font-size:1.5rem;margin-bottom:10px;}}
.sub{{color:#64748b;font-size:.9rem;margin-bottom:24px;direction:ltr;word-break:break-all;}}
.progress{{background:rgba(255,255,255,.08);border-radius:999px;height:6px;overflow:hidden;margin:20px 0;}}
.progress-fill{{height:100%;background:linear-gradient(90deg,#6366f1,#a855f7);
  animation:progress 2s ease-in-out infinite;border-radius:999px;}}
@keyframes progress{{0%{{width:15%;margin-right:85%;}}50%{{width:70%;margin-right:0%;}}100%{{width:15%;margin-right:85%;}}}}
.result-box{{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.25);
  border-radius:16px;padding:20px;margin-top:20px;display:none;}}
.error-box{{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);
  border-radius:16px;padding:20px;margin-top:20px;display:none;color:#fca5a5;}}
.link-btn{{display:inline-block;margin-top:14px;padding:12px 28px;
  background:linear-gradient(90deg,#6366f1,#a855f7);color:#fff;text-decoration:none;
  border-radius:12px;font-weight:700;font-size:.95rem;}}
.back-link{{color:#6366f1;text-decoration:none;font-size:.85rem;margin-top:16px;display:block;}}
#status-text{{color:#a5b4fc;font-size:.9rem;margin-top:8px;}}
</style>
</head>
<body>
<div class='card'>
  <div id='spinner-wrap'>
    <div class='spinner'></div>
    <h2>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ø±Ø´ÛŒÙˆ...</h2>
    <p class='sub'>{url[:60]}{'...' if len(url)>60 else ''}</p>
    <div class='progress'><div class='progress-fill'></div></div>
    <div id='status-text'>Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ â€” Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Û±Ûµ-Û´Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ø´Ø¯</div>
  </div>
  <div class='result-box' id='result-box'>
    <div style='font-size:1.4rem;margin-bottom:8px;'>âœ… Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯!</div>
    <div id='result-url' style='color:#64748b;font-size:.85rem;direction:ltr;word-break:break-all;'></div>
    <a id='view-link' href='#' class='link-btn'>ğŸ‘ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ø±Ø´ÛŒÙˆ</a>
  </div>
  <div class='error-box' id='error-box'>
    <div style='font-size:1.2rem;margin-bottom:8px;'>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆ</div>
    <div id='error-msg' style='font-size:.85rem;'></div>
  </div>
  <a href='/' class='back-link'>â† Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
</div>

<script>
const jobId = '{job_id}';
const base = '{base}';
let attempts = 0;

async function poll() {{
  attempts++;
  try {{
    const r = await fetch('/api/job/' + jobId);
    const d = await r.json();
    
    if (d.status === 'done' && d.archive_id) {{
      document.getElementById('spinner-wrap').style.display = 'none';
      const box = document.getElementById('result-box');
      box.style.display = 'block';
      document.getElementById('result-url').textContent = d.url;
      document.getElementById('view-link').href = base + '/view/' + d.archive_id;
      return;
    }}
    
    if (d.status === 'error') {{
      document.getElementById('spinner-wrap').style.display = 'none';
      const box = document.getElementById('error-box');
      box.style.display = 'block';
      document.getElementById('error-msg').textContent = d.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡';
      return;
    }}
    
    // Ù‡Ù†ÙˆØ² Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´
    if (attempts > 2) {{
      document.getElementById('status-text').textContent = 
        'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´... (' + attempts*3 + ' Ø«Ø§Ù†ÛŒÙ‡)';
    }}
    
    // max 3 minutes
    if (attempts < 60) {{
      setTimeout(poll, 3000);
    }} else {{
      document.getElementById('status-text').textContent = 'Ø²Ù…Ø§Ù† Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯. ØµÙØ­Ù‡ Ø±Ø§ refresh Ú©Ù†ÛŒØ¯.';
    }}
  }} catch(e) {{
    if (attempts < 60) setTimeout(poll, 4000);
  }}
}}

// Ø´Ø±ÙˆØ¹ polling Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
setTimeout(poll, 3000);
</script>
</body>
</html>"""
    return HTMLResponse(page)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GET /api/job/{id} â€” ÙˆØ¶Ø¹ÛŒØª job Ø¨Ø±Ø§ÛŒ polling
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/api/job/{job_id}")
async def get_job_status(job_id: str):
    job = _jobs.get(job_id)
    if not job:
        return JSONResponse({"status": "not_found"}, status_code=404)
    return JSONResponse(job)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# /view/{id}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/view/{archive_id}", response_class=HTMLResponse)
async def view_archive(archive_id: str):
    sb = get_supabase()
    row = None

    if sb:
        try:
            async with httpx.AsyncClient(timeout=15) as c:
                r = await c.get(
                    sb.base + "/rest/v1/archives",
                    headers={
                        "apikey": sb.key,
                        "Authorization": "Bearer " + sb.key,
                        "Accept": "application/json",
                    },
                    params={"id": "eq." + archive_id, "limit": "1"},
                )
                logger.info("view_archive status=%s body=%s", r.status_code, r.text[:200])
                if r.is_success and r.json():
                    row = r.json()[0]
        except Exception as e:
            logger.warning("view_archive DB error: %s", e)

    # fallback: local
    if not row:
        data_dir = Path(settings.base_storage_dir)
        if data_dir.exists():
            for folder in data_dir.iterdir():
                mf = folder / "manifest.json"
                if mf.exists():
                    try:
                        m = json.loads(mf.read_text())
                        if m.get("archive_id") == archive_id:
                            row = {"url": m.get("url", ""), "created_at": "",
                                   "screenshot_url": m.get("screenshot_url", ""),
                                   "html_url": ""}
                    except Exception:
                        pass

    if not row:
        return HTMLResponse(
            "<html dir='rtl'><head><meta charset='UTF-8'/><style>"
            "body{font-family:sans-serif;background:#060910;color:#e2e8f0;"
            "display:flex;align-items:center;justify-content:center;min-height:100vh;}</style></head>"
            "<body><div style='text-align:center'>"
            "<h2>âš ï¸ Ø¢Ø±Ø´ÛŒÙˆ ÛŒØ§ÙØª Ù†Ø´Ø¯</h2>"
            f"<p style='color:#64748b;margin-top:8px'>Ø´Ù†Ø§Ø³Ù‡: {archive_id}</p>"
            "<a href='/' style='color:#6366f1;margin-top:16px;display:block'>Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>"
            "</div></body></html>",
            status_code=404,
        )

    orig_url = row.get("url", "")
    screenshot_url = row.get("screenshot_url", "")
    html_url = row.get("html_url", "")
    created_at = (row.get("created_at", "") or "")[:19].replace("T", " ")
    author = ""
    if row.get("post_username") and row.get("post_author"):
        author = row["post_author"] + " (@" + row["post_username"] + ")"
    elif row.get("post_username"):
        author = "@" + row["post_username"]
    elif row.get("post_author"):
        author = row["post_author"]

    base = settings.archive_base or ""
    web_link = f"{base}/web/{archive_id}" if base else ""

    ss_html = ""
    if screenshot_url:
        ss_html = (
            "<div class='ss-wrap'>"
            "<div class='ss-bar'>"
            "<div class='dot' style='background:#ef4444'></div>"
            "<div class='dot' style='background:#eab308'></div>"
            "<div class='dot' style='background:#22c55e'></div>"
            f"<span style='color:#64748b;font-size:11px;margin-right:8px;'>{orig_url[:60]}</span>"
            "</div>"
            f"<img src='{screenshot_url}' class='ss-img' alt='screenshot'/>"
            "</div>"
        )
    else:
        ss_html = "<div class='no-ss'>ğŸ“¸ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div>"

    author_html = f"<span class='author'>ğŸ‘¤ {author}</span>" if author else ""
    web_btn = f"<a href='{web_link}' target='_blank' class='btn btn-cyan'>ğŸ‘ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ø±Ø´ÛŒÙˆ ÙˆØ¨</a>" if web_link else ""
    dl_btn = f"<a href='{html_url}' download class='btn btn-green'>â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ HTML</a>" if html_url else ""
    orig_short = orig_url[:65] + ("..." if len(orig_url) > 65 else "")

    page = f"""<!DOCTYPE html>
<html lang='fa' dir='rtl'>
<head>
<meta charset='UTF-8'/>
<meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>Ø¢Ø±Ø´ÛŒÙˆ â€” Archive Hub</title>
<link href='https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap' rel='stylesheet'/>
<style>
*{{box-sizing:border-box;margin:0;padding:0;}}
body{{font-family:'Vazirmatn',sans-serif;background:#060910;color:#e2e8f0;min-height:100vh;}}
.bar{{background:#1e3a8a;padding:12px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:100;}}
.bar .logo{{font-weight:700;color:#fff;font-size:15px;white-space:nowrap;}}
.bar a{{color:#93c5fd;font-size:12px;word-break:break-all;text-decoration:none;}}
.bar .date{{font-size:11px;color:#bfdbfe;margin-right:auto;white-space:nowrap;}}
.wrap{{max-width:960px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:16px;}}
.card{{background:rgba(255,255,255,.05);border:1px solid rgba(99,102,241,.2);border-radius:16px;padding:20px;}}
.meta{{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}}
.badge{{background:#1d4ed8;color:#fff;border-radius:6px;padding:4px 12px;font-size:12px;font-weight:600;}}
.author{{color:#a5b4fc;font-size:14px;}}
.btn{{padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:.2s;}}
.btn-blue{{background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.4);color:#a5b4fc;}}
.btn-cyan{{background:rgba(6,182,212,.15);border:1px solid rgba(6,182,212,.4);color:#67e8f9;}}
.btn-cyan:hover{{background:rgba(6,182,212,.3);}}
.btn-green{{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3);color:#86efac;}}
.ss-wrap{{border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.08);background:#0f172a;}}
.ss-bar{{background:#1e293b;padding:8px 12px;display:flex;gap:6px;align-items:center;}}
.dot{{width:10px;height:10px;border-radius:50%;flex-shrink:0;}}
.ss-img{{width:100%;display:block;max-height:700px;object-fit:cover;object-position:top;}}
.no-ss{{padding:40px;text-align:center;color:#475569;font-size:14px;}}
</style>
</head>
<body>
<div class='bar'>
  <span class='logo'>ğŸ“¦ Archive Hub</span>
  <a href='{orig_url}' target='_blank'>{orig_short}</a>
  <span class='date'>ğŸ• {created_at}</span>
</div>
<div class='wrap'>
  <div class='card'>
    <div class='meta'>
      <span class='badge'>âœ… Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡</span>
      {author_html}
      <a href='{orig_url}' target='_blank' class='btn btn-blue'>ğŸ”— Ù„ÛŒÙ†Ú© Ø§ØµÙ„ÛŒ â†—</a>
      {web_btn}
      {dl_btn}
    </div>
  </div>
  <div class='card'>{ss_html}</div>
</div>
</body>
</html>"""
    return HTMLResponse(page)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# /web/{id} â€” HTML Ú©Ø§Ù…Ù„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/web/{archive_id}", response_class=HTMLResponse)
async def view_web_archive(archive_id: str):
    sb = get_supabase()
    html_url = ""

    if sb:
        try:
            async with httpx.AsyncClient(timeout=15) as c:
                r = await c.get(
                    sb.base + "/rest/v1/archives",
                    headers={
                        "apikey": sb.key,
                        "Authorization": "Bearer " + sb.key,
                        "Accept": "application/json",
                    },
                    params={"id": "eq." + archive_id, "select": "html_url", "limit": "1"},
                )
                if r.is_success and r.json():
                    html_url = r.json()[0].get("html_url", "")
        except Exception as e:
            logger.warning("web_archive DB error: %s", e)

    if html_url:
        try:
            async with httpx.AsyncClient(timeout=30, follow_redirects=True) as c:
                r2 = await c.get(html_url)
                if r2.status_code == 200:
                    return HTMLResponse(r2.text)
        except Exception as e:
            logger.warning("html fetch error: %s", e)

    # fallback: local
    data_dir = Path(settings.base_storage_dir)
    if data_dir.exists():
        for folder in data_dir.iterdir():
            mf = folder / "manifest.json"
            if mf.exists():
                try:
                    m = json.loads(mf.read_text())
                    if m.get("archive_id") == archive_id:
                        html_path = folder / "archive.html"
                        if html_path.exists():
                            return HTMLResponse(html_path.read_text(encoding="utf-8"))
                except Exception:
                    pass

    return HTMLResponse(
        "<html dir='rtl'><head><meta charset='UTF-8'/></head>"
        "<body style='font-family:sans-serif;padding:40px;background:#060910;color:#e2e8f0;text-align:center;'>"
        "<h2>âš ï¸ ÙØ§ÛŒÙ„ Ø¢Ø±Ø´ÛŒÙˆ ÛŒØ§ÙØª Ù†Ø´Ø¯</h2>"
        f"<a href='/view/{archive_id}' style='color:#6366f1;margin-top:16px;display:block'>Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø¢Ø±Ø´ÛŒÙˆ</a>"
        "</body></html>",
        status_code=404,
    )


@app.get("/screenshot/{archive_id}")
async def view_screenshot(archive_id: str):
    data_dir = Path(settings.base_storage_dir)
    if data_dir.exists():
        for folder in data_dir.iterdir():
            mf = folder / "manifest.json"
            if mf.exists():
                try:
                    m = json.loads(mf.read_text())
                    if m.get("archive_id") == archive_id:
                        ss = folder / "screenshot.png"
                        if ss.exists() and ss.stat().st_size > 0:
                            return FileResponse(str(ss), media_type="image/png")
                except Exception:
                    pass
    return Response(status_code=404)


@app.post("/bot/webhook")
async def bot_webhook(request: Request):
    try:
        update = await request.json()
    except Exception:
        return JSONResponse({"ok": False}, status_code=400)
    from app.bot import handle_update
    asyncio.create_task(handle_update(update))
    return JSONResponse({"ok": True})


@app.get("/bot/set_webhook")
async def set_webhook(request: Request):
    if not settings.telegram_bot_token:
        return JSONResponse({"error": "TELEGRAM_BOT_TOKEN not set"})
    if not settings.webhook_url:
        return JSONResponse({"error": "WEBHOOK_URL not set"})
    endpoint = f"{settings.webhook_url.rstrip('/')}/bot/webhook"
    async with httpx.AsyncClient(timeout=10) as c:
        r = await c.post(
            f"https://api.telegram.org/bot{settings.telegram_bot_token}/setWebhook",
            json={"url": endpoint},
        )
        return JSONResponse(r.json())
