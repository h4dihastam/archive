<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† â€” Archive Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #060910;
  --surface: #0d1117;
  --border: rgba(99,102,241,.18);
  --accent: #6366f1;
  --accent2: #a855f7;
  --danger: #ef4444;
  --text: #e2e8f0;
  --muted: #64748b;
  --green: #22c55e;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Vazirmatn',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* â”€â”€ Auth screen â”€â”€ */
.auth-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 50% 0%,#1e1b4b 0%,#060910 70%);}
.auth-card{width:380px;background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:24px;padding:40px;backdrop-filter:blur(20px);}
.auth-card h1{font-size:1.6rem;margin-bottom:4px;
  background:linear-gradient(90deg,#a5b4fc,#c084fc);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-card p{color:var(--muted);margin-bottom:28px;font-size:.9rem;}
.inp{width:100%;padding:14px 18px;background:rgba(255,255,255,.06);
  border:1px solid var(--border);border-radius:14px;color:var(--text);
  font-size:1rem;font-family:inherit;outline:none;transition:.2s;}
.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(99,102,241,.2);}
.btn{width:100%;padding:14px;margin-top:16px;background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none;border-radius:14px;color:#fff;font-size:1rem;font-family:inherit;
  font-weight:700;cursor:pointer;transition:.3s;}
.btn:hover{opacity:.9;transform:translateY(-1px);}
.err{color:#fca5a5;font-size:.88rem;margin-top:10px;text-align:center;}

/* â”€â”€ Dashboard â”€â”€ */
.layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
.sidebar{background:var(--surface);border-left:1px solid var(--border);padding:24px 16px;}
.sidebar .logo{font-size:1.2rem;font-weight:700;padding:8px 12px;margin-bottom:24px;
  background:linear-gradient(90deg,#a5b4fc,#c084fc);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:12px 14px;
  background:none;border:none;color:var(--muted);font-family:inherit;font-size:.92rem;
  border-radius:12px;cursor:pointer;text-align:right;transition:.2s;}
.nav-btn:hover,.nav-btn.active{background:rgba(99,102,241,.12);color:#a5b4fc;}
.nav-btn.danger:hover{background:rgba(239,68,68,.1);color:#fca5a5;}
.main{padding:32px;overflow-y:auto;}
.page{display:none;animation:fadeIn .3s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* Stats cards */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:32px;}
.stat-card{background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:20px;padding:24px;transition:.3s;}
.stat-card:hover{transform:translateY(-4px);border-color:rgba(99,102,241,.4);}
.stat-val{font-size:2.2rem;font-weight:700;background:linear-gradient(90deg,#a5b4fc,#c084fc);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.stat-lbl{color:var(--muted);font-size:.85rem;margin-top:4px;}

/* Table */
.tbl-wrap{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:20px;overflow:hidden;}
.tbl-head{padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;}
.tbl-head h3{font-size:1rem;font-weight:600;}
table{width:100%;border-collapse:collapse;}
th{padding:12px 16px;text-align:right;font-size:.8rem;color:var(--muted);
  text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border);}
td{padding:12px 16px;font-size:.88rem;border-bottom:1px solid rgba(255,255,255,.04);}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.03);}
.badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:.75rem;font-weight:600;}
.badge-ok{background:rgba(34,197,94,.15);color:#86efac;}
.url-cell{max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.url-cell a{color:#93c5fd;text-decoration:none;}
.url-cell a:hover{text-decoration:underline;}
.del-btn{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);
  color:#fca5a5;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:.8rem;
  font-family:inherit;transition:.2s;}
.del-btn:hover{background:rgba(239,68,68,.25);}

.section-title{font-size:1.4rem;font-weight:700;margin-bottom:20px;}
.refresh-btn{background:rgba(99,102,241,.12);border:1px solid var(--border);
  color:#a5b4fc;padding:8px 16px;border-radius:10px;cursor:pointer;font-family:inherit;font-size:.85rem;}
.refresh-btn:hover{background:rgba(99,102,241,.22);}
.logout-btn{margin-top:auto;padding-top:16px;border-top:1px solid var(--border);}
.storage-bar{height:8px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;margin-top:8px;}
.storage-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:999px;transition:width .6s ease;}
</style>
</head>
<body>

<!-- â”€â”€ Auth Screen â”€â”€ -->
<div class="auth-wrap" id="authScreen">
  <div class="auth-card">
    <h1>ğŸ—„ Archive Hub</h1>
    <p>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª â€” ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</p>
    <input class="inp" type="password" id="pwdInput" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ†" onkeydown="if(event.key==='Enter')login()"/>
    <button class="btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
    <div class="err" id="authErr"></div>
  </div>
</div>

<!-- â”€â”€ Dashboard â”€â”€ -->
<div class="layout" id="dashboard" style="display:none;">
  <div class="sidebar">
    <div class="logo">ğŸ—„ Archive Hub</div>
    <button class="nav-btn active" onclick="showPage('stats',this)">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
    <button class="nav-btn" onclick="showPage('archives',this)">ğŸ—ƒ Ø¢Ø±Ø´ÛŒÙˆÙ‡Ø§</button>
    <button class="nav-btn" onclick="showPage('users',this)">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
    <div style="margin-top:auto;padding-top:16px;border-top:1px solid var(--border);margin-top:200px;">
      <button class="nav-btn danger" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  <div class="main">

    <!-- Stats Page -->
    <div class="page active" id="page-stats">
      <div class="section-title">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="stat-archives">â€”</div>
          <div class="stat-lbl">Ú©Ù„ Ø¢Ø±Ø´ÛŒÙˆÙ‡Ø§</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-users">â€”</div>
          <div class="stat-lbl">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø¨Ø§Øª</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-files">â€”</div>
          <div class="stat-lbl">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Storage</div>
        </div>
      </div>
      <div class="tbl-wrap" style="padding:24px;">
        <div style="font-weight:600;margin-bottom:12px;">ğŸ’¾ Ø­Ø¬Ù… Storage</div>
        <div id="stat-size" style="font-size:1.8rem;font-weight:700;color:#a5b4fc;">â€”</div>
        <div class="storage-bar"><div class="storage-fill" id="storage-fill" style="width:0%"></div></div>
        <div style="color:var(--muted);font-size:.8rem;margin-top:6px;">Ø­Ø¯Ø§Ú©Ø«Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Supabase: 1 GB</div>
      </div>
    </div>

    <!-- Archives Page -->
    <div class="page" id="page-archives">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
        <div class="section-title" style="margin:0;">ğŸ—ƒ Ø¢Ø±Ø´ÛŒÙˆÙ‡Ø§</div>
        <button class="refresh-btn" onclick="loadArchives()">â†» Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Ø´Ù†Ø§Ø³Ù‡</th><th>URL</th><th>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</th><th>Ú©Ø§Ø±Ø¨Ø±</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
          </tr></thead>
          <tbody id="archiveTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Users Page -->
    <div class="page" id="page-users">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
        <div class="section-title" style="margin:0;">ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
        <button class="refresh-btn" onclick="loadUsers()">â†» Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>User ID</th><th>ÛŒÙˆØ²Ø±Ù†ÛŒÙ…</th><th>Ù†Ø§Ù…</th><th>ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª</th>
          </tr></thead>
          <tbody id="userTbody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const ADMIN_PASSWORD = "{{ admin_password }}";

function login() {
  const pwd = document.getElementById('pwdInput').value;
  if (pwd === ADMIN_PASSWORD) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'grid';
    loadStats();
    loadArchives();
    loadUsers();
  } else {
    document.getElementById('authErr').textContent = 'âŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª';
  }
}

function logout() {
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('pwdInput').value = '';
}

function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  btn.classList.add('active');
}

async function apiFetch(path) {
  const r = await fetch('/admin/api' + path, {
    headers: {'X-Admin-Key': document.getElementById('pwdInput').value || sessionStorage.getItem('adminPwd') || ''}
  });
  return r.json();
}

async function loadStats() {
  const d = await apiFetch('/stats');
  document.getElementById('stat-archives').textContent = d.total_archives ?? 'â€”';
  document.getElementById('stat-users').textContent = d.total_users ?? 'â€”';
  document.getElementById('stat-files').textContent = d.file_count ?? 'â€”';
  const bytes = d.total_bytes || 0;
  let sizeStr = bytes < 1048576 ? (bytes/1024).toFixed(1)+' KB'
    : bytes < 1073741824 ? (bytes/1048576).toFixed(1)+' MB'
    : (bytes/1073741824).toFixed(2)+' GB';
  document.getElementById('stat-size').textContent = sizeStr;
  const pct = Math.min((bytes / (1024*1024*1024)) * 100, 100);
  document.getElementById('storage-fill').style.width = pct + '%';
}

async function loadArchives() {
  const rows = await apiFetch('/archives');
  const tb = document.getElementById('archiveTbody');
  tb.innerHTML = rows.map(r => {
    const short = (r.id||'').slice(0,8);
    const date = (r.created_at||'').slice(0,10);
    const author = r.post_username ? '@'+r.post_username : (r.post_author||'â€”');
    const savedBy = r.saved_by_username ? '@'+r.saved_by_username : 'â€”';
    return `<tr>
      <td><code style="color:#a5b4fc;font-size:.8rem;">${short}</code></td>
      <td class="url-cell"><a href="${r.url}" target="_blank">${r.url}</a></td>
      <td>${author}</td>
      <td>${savedBy}</td>
      <td>${date}</td>
      <td><button class="del-btn" onclick="deleteArchive('${r.id}', this)">ğŸ—‘ Ø­Ø°Ù</button></td>
    </tr>`;
  }).join('');
}

async function loadUsers() {
  const rows = await apiFetch('/users');
  const tb = document.getElementById('userTbody');
  tb.innerHTML = rows.map(u => {
    const date = (u.created_at||'').slice(0,10);
    return `<tr>
      <td><code style="color:#a5b4fc;">${u.user_id}</code></td>
      <td>${u.username ? '@'+u.username : 'â€”'}</td>
      <td>${u.full_name||'â€”'}</td>
      <td>${date}</td>
    </tr>`;
  }).join('');
}

async function deleteArchive(id, btn) {
  if (!confirm('Ø¢Ø±Ø´ÛŒÙˆ ' + id.slice(0,8) + ' Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  btn.disabled = true;
  btn.textContent = '...';
  const r = await fetch('/admin/api/delete/' + id, {
    method: 'DELETE',
    headers: {'X-Admin-Key': document.getElementById('pwdInput').value || ''}
  });
  if (r.ok) {
    btn.closest('tr').style.opacity = '0.3';
    setTimeout(() => btn.closest('tr').remove(), 400);
    loadStats();
  } else {
    btn.textContent = 'âŒ';
  }
}
</script>
</body>
</html>
